<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vibe Code Typing - Test Runner</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; color: #333; }
        .container { max-width: 800px; margin: 2em auto; padding: 1em 2em; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: #2c3e50; }
        #test-form { margin-top: 1.5em; display: flex; flex-direction: column; align-items: flex-start; }
        #test-selection-container { margin-bottom: 1.5em; }
        .test-option { display: block; margin-bottom: 0.5em; font-size: 1.1em; }
        .button-group { display: flex; gap: 10px; }
        button { font-size: 1em; padding: 10px 20px; border-radius: 5px; border: none; color: white; cursor: pointer; }
        #run-btn { background-color: #3498db; }
        #run-btn:hover { background-color: #2980b9; }
        #mutate-btn { background-color: #9b59b6; }
        #mutate-btn:hover { background-color: #8e44ad; }
        #mutation-status { margin-top: 1.5em; font-family: monospace; font-size: 1.1em; white-space: pre; }
        p { line-height: 1.6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Runner</h1>
        <p>Select the test suites you want to run, then check the browser's developer console (F12) for the results.</p>
        
        <form id="test-form">
            <h2>Available Tests</h2>
            <div id="test-selection-container">
                <!-- Checkboxes will be dynamically inserted here -->
            </div>
            <div class="button-group">
                <button id="run-btn" type="submit">Run Selected Tests</button>
                <button id="mutate-btn" type="button">Run Mutation Tests</button>
            </div>
        </form>

        <div id="mutation-status"></div>
    </div>

    <!-- This sandbox is where tests will safely manipulate the DOM -->
    <div id="test-sandbox"></div>

    <script>
        // With ESM, we only need to know the entry point for each test suite.
        // The browser will handle loading all nested dependencies.
        const AVAILABLE_TESTS = [
            { name: "TextGenerator", testPath: "../TextGenerator.test.js" },
            { name: "InputHandler", testPath: "../InputHandler.test.js" },
            { name: "PerformanceAnalyzer", testPath: "../PerformanceAnalyzer.test.js" },
            { name: "TypingJournal", testPath: "../TypingJournal.test.js" },
            { name: "Renderer", testPath: "../Renderer.test.js" },
            { name: "TypingGame", testPath: "../TypingGame.test.js" },
        ];

        const form = document.getElementById('test-form');
        const selectionContainer = document.getElementById('test-selection-container');
        
        function populateTestOptions() {
            AVAILABLE_TESTS.forEach(test => {
                const label = document.createElement('label');
                label.className = 'test-option';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'tests';
                checkbox.value = test.name;
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(` ${test.name}`));
                selectionContainer.appendChild(label);
            });
        }

        async function runUnitTests(testsToRun) {
            console.clear();
            console.log("--- UNIT TEST RUN STARTED ---");

            try {
                // Dynamically import the framework modules.
                // The browser's module cache prevents re-execution.
                await import('./Assertions.js'); // Path changed
                await import('./Collector.js');  // Path changed
                await import('./Reporter.js');   // Path changed
                const { Test } = await import('./test-framework.js'); // Path changed

                // Loop through and load each selected test module.
                for (const testName of testsToRun) {
                    const testConfig = AVAILABLE_TESTS.find(t => t.name === testName);
                    if (testConfig) {
                        await import(testConfig.testPath);
                    }
                }

                Test.summarize();

            } catch (error) {
                console.error("A critical error occurred during the test run:", error);
            }
        }
        
        async function runMutationTests(testsToRun) {
            const statusDiv = document.getElementById('mutation-status');
            statusDiv.textContent = "Mutation testing is not yet implemented.";
            console.log("Mutation testing workflow would start here for:", testsToRun);
            // This is the entry point for our future mutation testing logic.
        }

        function getSelectedTests() {
             const formData = new FormData(form);
             return formData.getAll('tests');
        }

        // --- Event Listeners ---

        form.addEventListener('submit', (event) => {
            event.preventDefault();
            const selectedTests = getSelectedTests();
            const newUrl = new URL(window.location.pathname, window.location.origin);
            selectedTests.forEach(test => newUrl.searchParams.append('tests', test));
            window.location.href = newUrl.href; // Reload the page with new params
        });

        document.getElementById('mutate-btn').addEventListener('click', async () => {
            const selectedTests = getSelectedTests();
            if (selectedTests.length > 0) {
                 await runMutationTests(selectedTests);
            } else {
                alert("Please select at least one test suite to mutate.");
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            populateTestOptions();
            
            // Check URL params to run tests on page load
            const params = new URLSearchParams(window.location.search);
            const testsToRunOnLoad = params.getAll('tests');

            if (testsToRunOnLoad.length > 0) {
                document.querySelectorAll('input[name="tests"]').forEach(checkbox => {
                    if (testsToRunOnLoad.includes(checkbox.value)) {
                        checkbox.checked = true;
                    }
                });
                runUnitTests(testsToRunOnLoad);
            }
        });
    </script>
</body>
</html>