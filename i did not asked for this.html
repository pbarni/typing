<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solving "Chunky" Text Styling - Final Version</title>
    <style>
        /* --- Basic Page Setup --- */
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 2rem;
            font-size: 1.5rem;
            line-height: 2;
        }
        h1, h2, p {
            max-width: 900px;
            margin: 1rem auto;
        }
        h1 { color: #3498db; }
        h2 { border-bottom: 2px solid #34495e; padding-bottom: 0.5rem; margin-top: 3rem; }
        code { background-color: #34495e; padding: 2px 5px; border-radius: 3px; }

        /* --- Text Container Styles --- */
        .text-container {
            position: relative; /* CRITICAL: Anchor for our overlay boxes */
            background-color: #34495e;
            padding: 10px;
            border-radius: 5px;
            max-width: 900px;
            margin: 1rem auto;
            white-space: pre-wrap; /* CRITICAL: Handles \n characters automatically without needing <br> */
            user-select: none;
        }

        /* --- Character Span Styles --- */
        .text-container span {
            /* Spans only control color, not background or decoration */
        }
        .text-container .default { color: #7f8c8d; }
        .text-container .correct { color: #2ecc71; }
        .text-container .incorrect { color: #e74c3c; }
        .text-container .newline { color: #6a7c8e; } /* Styles the '↵' symbol */

        /* --- Overlay Box Styles (The Solution!) --- */
        .overlay-box {
            position: absolute;
            pointer-events: none;
            border-radius: 3px;
        }
        .overlay-selection {
            background-color: #3498db;
        }
        .overlay-underline {
            background-color: #e74c3c;
            height: 2px;
            border-radius: 0;
        }
        /* NEW: Style for the cursor overlay */
        .overlay-cursor {
            background-color: #52667a; /* The old block cursor color */
        }
    </style>
</head>
<body>

    <h1>Solving "Chunky" Text Styling - Final Version</h1>
    <p>This version re-introduces the **cursor** and **newline characters**, implemented in a way that is compatible with the seamless overlay-drawing technique.</p>

    <!-- ==================================================================================== -->
    <!-- EXAMPLE 1: Cursor Only (No Selection)                                                -->
    <!-- ==================================================================================== -->
    <h2>Edge Case 1: Cursor Only</h2>
    <p>The cursor is now also an overlay, drawn perfectly over a single character.</p>
    <div class="text-container" id="example1"></div>

    <!-- ==================================================================================== -->
    <!-- EXAMPLE 2: Multi-line Selection (Cursor at the end)                                  -->
    <!-- ==================================================================================== -->
    <h2>Edge Case 2: Multi-line Selection</h2>
    <p>The cursor is hidden when a selection is active. The selection remains seamless.</p>
    <div class="text-container" id="example2"></div>

    <!-- ==================================================================================== -->
    <!-- EXAMPLE 3: Multi-line Underline (with active cursor)                                 -->
    <!-- ==================================================================================== -->
    <h2>Edge Case 3: Multi-line Underline</h2>
    <p>Underlines and the cursor can co-exist without interfering with each other.</p>
    <div class="text-container" id="example3"></div>

    <!-- ==================================================================================== -->
    <!-- EXAMPLE 4: Selection including a newline character                                   -->
    <!-- ==================================================================================== -->
    <h2>Edge Case 4: Selection Including a Newline</h2>
    <p>The <code>white-space: pre-wrap</code> style correctly handles the line break, and the overlay flows across it.</p>
    <div class="text-container" id="example4"></div>


    <script>
        class VisualDebugger {
            constructor(containerId, text) {
                this.container = document.getElementById(containerId);
                this.text = text;
                this.charSpans = [];

                this.init();
            }

            // MODIFIED: No longer adds <br> tags. Relies on `white-space: pre-wrap`.
            init() {
                this.container.innerHTML = '';
                for (const char of this.text) {
                    const span = document.createElement('span');
                    if (char === '\n') {
                        span.innerHTML = '↵'; // Display newline character
                        span.className = 'newline';
                    } else if (char === ' ') {
                        span.innerHTML = '&nbsp;';
                        span.className = 'default';
                    } else {
                        span.innerText = char;
                        span.className = 'default';
                    }
                    this.container.appendChild(span);
                    this.charSpans.push(span);
                }
            }

            // MODIFIED: Now takes cursorPosition and decides whether to draw a cursor or selection.
            drawOverlays(ranges, cursorPosition) {
                this.container.querySelectorAll('.overlay-box').forEach(el => el.remove());
                const containerRect = this.container.getBoundingClientRect();

                // Determine if there is an active selection
                const hasSelection = ranges.some(r => r.start !== r.end);

                // --- Draw Cursor if there is NO selection ---
                if (!hasSelection && cursorPosition < this.charSpans.length) {
                    const cursorSpan = this.charSpans[cursorPosition];
                    const rect = cursorSpan.getBoundingClientRect();
                    const overlay = document.createElement('div');
                    
                    overlay.className = 'overlay-box overlay-cursor';
                    overlay.style.top = `${rect.top - containerRect.top}px`;
                    overlay.style.left = `${rect.left - containerRect.left}px`;
                    overlay.style.width = `${rect.width}px`;
                    overlay.style.height = `${rect.height}px`;
                    this.container.appendChild(overlay);
                }

                // --- Draw Selection and Underline Ranges ---
                for (const range of ranges) {
                    if (range.start >= range.end) continue;

                    const domRange = document.createRange();
                    // Clamp ranges to be within the bounds of available spans
                    const startIndex = Math.min(range.start, this.charSpans.length - 1);
                    const endIndex = Math.min(range.end - 1, this.charSpans.length - 1);

                    domRange.setStart(this.charSpans[startIndex], 0);
                    domRange.setEnd(this.charSpans[endIndex], 1);

                    const rects = domRange.getClientRects();

                    for (const rect of rects) {
                        const overlay = document.createElement('div');
                        overlay.className = `overlay-box ${range.type}`;
                        
                        const top = rect.top - containerRect.top;
                        const left = rect.left - containerRect.left;

                        if (range.type === 'overlay-underline') {
                           overlay.style.top = `${top + rect.height - 4}px`;
                        } else {
                           overlay.style.top = `${top}px`;
                        }
                        
                        overlay.style.left = `${left}px`;
                        overlay.style.width = `${rect.width}px`;
                        
                        if (range.type !== 'overlay-underline') {
                            overlay.style.height = `${rect.height}px`;
                        }
                        
                        this.container.appendChild(overlay);
                    }
                }
            }
        }

        // --- SETUP AND RUN THE EXAMPLES ---

        // Example 1: Cursor only
        const text1 = "A simple line of text with the cursor in the middle.";
        const demo1 = new VisualDebugger('example1', text1);
        demo1.drawOverlays([], 29); // No ranges, just a cursor at index 29
        demo1.charSpans[29].className = 'correct'; // Show the character under the cursor


        // Example 2: Multi-line Selection
        const text2 = "This is a long line of text that is designed to wrap onto multiple lines to demonstrate the selection.";
        const demo2 = new VisualDebugger('example2', text2);
        const selectionRange2 = [{ start: 10, end: 80, type: 'overlay-selection' }];
        demo2.drawOverlays(selectionRange2, 80); // Cursor is at the end of selection, so it's hidden
        for (let i = 10; i < 80; i++) { demo2.charSpans[i].className = 'correct'; }


        // Example 3: Multi-line Underline (with active cursor)
        const text3 = "Here is some text with a very long incorrect section, and the cursor is active within it.";
        const demo3 = new VisualDebugger('example3', text3);
        const underlineRange3 = [{ start: 26, end: 70, type: 'overlay-underline' }];
        demo3.drawOverlays(underlineRange3, 50); // Cursor at index 50
        for (let i = 26; i < 70; i++) { demo3.charSpans[i].className = 'incorrect'; }


        // Example 4: Selection including a newline
        const text4 = "Select this text\nand the text on the next line.";
        const demo4 = new VisualDebugger('example4', text4);
        const selectionRange4 = [{ start: 7, end: 32, type: 'overlay-selection' }];
        demo4.drawOverlays(selectionRange4, 32); // Cursor at the end, hidden
        for (let i = 7; i < 32; i++) { if(text4[i] !== '\n') demo4.charSpans[i].className = 'correct'; }

    </script>

</body>
</html>